name: "AI Automation: Approve Copilot Runs"

# This workflow auto-approves pending workflow runs from Copilot.
# Since Copilot is a GitHub App, its workflow runs require manual approval.
# This workaround uses scheduled/manual triggers (which are trusted) to approve them.

on:
  # Run every 5 minutes to catch pending Copilot runs quickly
  schedule:
    - cron: '*/5 * * * *'
  
  # Manual trigger for immediate approval
  workflow_dispatch:

permissions:
  actions: write

jobs:
  approve-copilot-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Approve pending Copilot workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all runs waiting for approval
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              status: 'action_required',
              per_page: 100
            });
            
            console.log(`Found ${runs.total_count} runs requiring approval`);
            
            let approved = 0;
            let skipped = 0;
            
            for (const run of runs.workflow_runs) {
              // Only approve runs from Copilot or known bot accounts
              const trustedActors = [
                'Copilot',
                'copilot',
                'copilot-swe-agent',
                'github-actions',
                'dependabot'
              ];
              
              const actorLogin = run.actor?.login || '';
              const isTrusted = trustedActors.some(a => 
                actorLogin.toLowerCase() === a.toLowerCase() ||
                actorLogin.toLowerCase().includes(a.toLowerCase())
              );
              
              if (isTrusted) {
                try {
                  await github.rest.actions.approveWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id
                  });
                  console.log(`✅ Approved run ${run.id} (${run.name}) from ${actorLogin}`);
                  approved++;
                } catch (error) {
                  console.log(`⚠️ Could not approve run ${run.id}: ${error.message}`);
                }
              } else {
                console.log(`⏭️ Skipped run ${run.id} from ${actorLogin} (not a trusted bot)`);
                skipped++;
              }
            }
            
            console.log(`\nSummary: Approved ${approved}, Skipped ${skipped}`);
