<% content_for :title, "Webhook Details | #{@agent.name} | Builder Dashboard | Evald.ai" %>

<div class="max-w-4xl mx-auto">
  <div class="flex items-center space-x-3 mb-8">
    <%= link_to "← Webhooks", builder_agent_webhooks_path(@agent), class: "text-gray-500 hover:text-gray-700" %>
    <span class="text-gray-300">/</span>
    <h1 class="text-2xl font-bold text-gray-900">Webhook Details</h1>
  </div>

  <!-- Webhook Info -->
  <div class="bg-white rounded-xl p-6 shadow mb-8">
    <div class="flex items-start justify-between mb-6">
      <div>
        <div class="flex items-center space-x-3">
          <% if @webhook.enabled? %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>
          <% else %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Disabled</span>
          <% end %>
          <% if @webhook.failure_count > 0 %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
              <%= @webhook.failure_count %> consecutive failures
            </span>
          <% end %>
        </div>
        <p class="mt-2 text-gray-900 font-mono text-sm"><%= @webhook.url %></p>
      </div>
      <div class="flex space-x-2">
        <%= button_to toggle_builder_agent_webhook_path(@agent, @webhook), method: :post, class: "px-3 py-1.5 text-sm font-medium rounded-lg #{@webhook.enabled? ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}" do %>
          <%= @webhook.enabled? ? "Disable" : "Enable" %>
        <% end %>
        <%= button_to builder_agent_webhook_path(@agent, @webhook), method: :delete, class: "px-3 py-1.5 text-sm font-medium rounded-lg bg-red-100 text-red-700 hover:bg-red-200", data: { turbo_confirm: "Delete this webhook?" } do %>
          Delete
        <% end %>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <h3 class="text-sm font-medium text-gray-500 mb-2">Subscribed Events</h3>
        <div class="flex flex-wrap gap-1">
          <% @webhook.events.each do |event| %>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">
              <%= event %>
            </span>
          <% end %>
        </div>
      </div>
      <div>
        <h3 class="text-sm font-medium text-gray-500 mb-2">Statistics</h3>
        <dl class="text-sm">
          <div class="flex justify-between py-1">
            <dt class="text-gray-600">Created</dt>
            <dd class="text-gray-900"><%= @webhook.created_at.strftime("%B %d, %Y") %></dd>
          </div>
          <div class="flex justify-between py-1">
            <dt class="text-gray-600">Last triggered</dt>
            <dd class="text-gray-900"><%= @webhook.last_triggered_at ? time_ago_in_words(@webhook.last_triggered_at) + " ago" : "Never" %></dd>
          </div>
          <% if @webhook.disabled_at %>
            <div class="flex justify-between py-1">
              <dt class="text-gray-600">Disabled at</dt>
              <dd class="text-red-600"><%= @webhook.disabled_at.strftime("%B %d, %Y %H:%M") %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>
  </div>

  <!-- Signing Secret -->
  <div class="bg-white rounded-xl p-6 shadow mb-8">
    <div class="flex items-start justify-between">
      <div>
        <h2 class="text-lg font-bold text-gray-900 mb-2">Signing Secret</h2>
        <p class="text-gray-500 text-sm mb-4">Use this secret to verify webhook signatures. The signature is sent in the <code class="bg-gray-100 px-1 rounded">X-Evald-Signature</code> header.</p>
        <div class="bg-gray-50 rounded-lg p-3 font-mono text-sm text-gray-700 break-all">
          <%= @webhook.secret %>
        </div>
      </div>
      <div>
        <%= button_to regenerate_secret_builder_agent_webhook_path(@agent, @webhook), method: :post, class: "px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200", data: { turbo_confirm: "Regenerate secret? Your current secret will stop working." } do %>
          Regenerate
        <% end %>
      </div>
    </div>
  </div>

  <!-- Verification Example -->
  <div class="bg-white rounded-xl p-6 shadow mb-8">
    <h2 class="text-lg font-bold text-gray-900 mb-4">Verification Example</h2>
    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
      <pre class="text-sm text-gray-100"><code># Ruby example
secret = "<%= @webhook.secret %>"
payload = request.raw_post
signature = request.headers["X-Evald-Signature"]

expected = "sha256=" + OpenSSL::HMAC.hexdigest("SHA256", secret, payload)
valid = ActiveSupport::SecurityUtils.secure_compare(expected, signature)</code></pre>
    </div>
  </div>

  <!-- Delivery History -->
  <div class="bg-white rounded-xl p-6 shadow">
    <h2 class="text-lg font-bold text-gray-900 mb-4">Recent Deliveries</h2>

    <% if @deliveries.any? %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Event</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Response</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Attempts</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <% @deliveries.each do |delivery| %>
              <tr>
                <td class="px-4 py-3">
                  <% case delivery.status %>
                  <% when "delivered" %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      Delivered
                    </span>
                  <% when "failed" %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                      Failed
                    </span>
                  <% when "pending" %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                      Pending
                    </span>
                  <% when "delivering" %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      Delivering
                    </span>
                  <% end %>
                </td>
                <td class="px-4 py-3 font-mono text-sm text-gray-700"><%= delivery.event_type %></td>
                <td class="px-4 py-3">
                  <% if delivery.response_code %>
                    <span class="font-mono text-sm <%= delivery.response_code < 400 ? 'text-green-600' : 'text-red-600' %>">
                      <%= delivery.response_code %>
                    </span>
                  <% elsif delivery.error_message %>
                    <span class="text-red-600 text-sm truncate max-w-xs block" title="<%= delivery.error_message %>">
                      <%= truncate(delivery.error_message, length: 40) %>
                    </span>
                  <% else %>
                    <span class="text-gray-400 text-sm">—</span>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-sm text-gray-600"><%= delivery.attempt_count %></td>
                <td class="px-4 py-3 text-sm text-gray-500">
                  <%= time_ago_in_words(delivery.created_at) %> ago
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-8">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
        </svg>
        <h3 class="mt-4 text-sm font-medium text-gray-900">No deliveries yet</h3>
        <p class="mt-1 text-sm text-gray-500">Webhook deliveries will appear here when events are triggered.</p>
      </div>
    <% end %>
  </div>
</div>
